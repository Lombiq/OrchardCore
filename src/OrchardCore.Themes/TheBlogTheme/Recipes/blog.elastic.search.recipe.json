{
  "name": "Blog.Elasticsearch.Search",
  "displayName": "Blog - Elasticsearch Search",
  "description": "Creates Elasticsearch settings, permission and indices.",
  "author": "The Orchard Core Team",
  "website": "https://orchardcore.net",
  "version": "1.0.0",
  "issetuprecipe": false,
  "categories": [ "default" ],
  "tags": [ "blog", "Elasticsearch" ],

  "variables": {
    "searchIndexProfileId": "[js:uuid()]"
  },

  "steps": [
    {
      "name": "feature",
      "enable": [
        "OrchardCore.Search.Elasticsearch",
        "OrchardCore.Search"
      ]
    },
    {
      // Create the indices before the content items so they are indexed automatically. These are not all the available
      // settings, but the rest comes from the defaults.
      "name": "ElasticIndexSettings",
      "Indices": [
        {
          "search": {
            "Id": "[js: variables('searchIndexProfileId')]",
            "ProviderName": "Elasticsearch",
            "Type": "Content",
            "Name": "search",
            "IndexName": "search",
            "IndexFullName": "default_search",
            "Properties": {
              "ElasticsearchIndexMetadata": {
                "StoreSourceData": true,
                "AnalyzerName": "standard",
                "IndexMappings": {
                  "KeyFieldName": "ContentItemId",
                  "Mapping": {
                    "properties": {
                      "ContentItemId": {
                        "type": "keyword"
                      },
                      "ContentItemVersionId": {
                        "type": "keyword"
                      },
                      "Content.ContentItem.Owner": {
                        "type": "keyword"
                      },
                      "Content.ContentItem.FullText": {
                        "type": "text"
                      },
                      "Content.ContentItem.ContainedPart": {
                        "properties": {
                          "Ids": {
                            "type": "keyword"
                          },
                          "Order": {
                            "type": "float"
                          }
                        },
                        "type": "object"
                      },
                      "Content.ContentItem.DisplayText": {
                        "properties": {
                          "Analyzed": {
                            "type": "text"
                          },
                          "Normalized": {
                            "type": "keyword"
                          },
                          "Keyword": {
                            "type": "keyword"
                          }
                        },
                        "type": "object"
                      },
                      "Content.ContentItem.ContentType": {
                        "type": "keyword"
                      }
                    },
                    "_source": {
                      "enabled": true,
                      "excludes": [
                        "Content.ContentItem.DisplayText.Analyzed"
                      ]
                    }
                  }
                }
              },
              "ElasticsearchDefaultQueryMetadata": {
                "QueryAnalyzerName": "standard",
                "DefaultSearchFields": [
                  "Content.ContentItem.FullText"
                ]
              },
              "ContentIndexMetadata": {
                "IndexLatest": false,
                "IndexedContentTypes": [
                  "Article",
                  "Blockquote",
                  "Blog",
                  "BlogPost",
                  "Container",
                  "Image",
                  "LinkMenuItem",
                  "Menu",
                  "Page",
                  "Paragraph",
                  "RawHtml"
                ],
                "Culture": "any"
              }
            }
          }
        }
      ]
    },
    {
      // Create the search settings.
      "name": "Settings",
      "ElasticSettings": {
        "SearchIndex": "search",
        "DefaultSearchFields": [
          "Content.ContentItem.FullText"
        ],
        "SearchType": "",
        "DefaultQuery": null,
        "SyncWithLucene": true
      },
      "SearchSettings": {
        "DefaultIndexProfileName": "[js: variables('searchIndexProfileId')]"
      }
    },
    {
      "name": "elastic-index-rebuild",
      "Indices": [
        "search"
      ]
    },
    {
      // Create the search index permissions.
      "name": "Roles",
      "Roles": [
        {
          "Name": "Anonymous",
          "Description": "Anonymous role",
          "Permissions": [
            "ViewContent",
            "QueryElasticsearchSearchIndex"
          ]
        }
      ]
    }
  ]
}
